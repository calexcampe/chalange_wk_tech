unit uPedidoController;

interface

uses
  System.SysUtils, System.Generics.Collections,
  uPedidoModel, uPedidoItemModel, uClienteDAO, uProdutoDAO, uPedidoDAO,
  uClienteModel, uProdutoModel;

type
  TPedidoController = class
  private
    FPedido: TPedidoModel;
    FClienteDAO: TClienteDAO;
    FProdutoDAO: TProdutoDAO;
    FPedidoDAO: TPedidoDAO;

    procedure AtualizarTotal;
  public
    constructor Create;
    destructor Destroy; override;

    function NovoPedido: TPedidoModel;
    function BuscarCliente(Codigo: Integer): TClienteModel;
    function BuscarProduto(Codigo: Integer): TProdutoModel;

    procedure AdicionarItem(CodProd: Integer; Qtd: Double; ValorUnit: Double);
    procedure EditarItem(Index: Integer; Qtd: Double; ValorUnit: Double);
    procedure RemoverItem(Index: Integer);

    function GravarPedido: Integer;
    function CarregarPedido(Numero: Integer): TPedidoModel;
    procedure CancelarPedido(Numero: Integer);

    property Pedido: TPedidoModel read FPedido;
  end;

implementation

{ TPedidoController }

constructor TPedidoController.Create;
begin
  FPedido := TPedidoModel.Create;
  FPedidoDAO := TPedidoDAO.Create;
  FClienteDAO := TClienteDAO.Create;
  FProdutoDAO := TProdutoDAO.Create;
end;

destructor TPedidoController.Destroy;
begin
  FPedido.Free;
  FClienteDAO.Free;
  FProdutoDAO.Free;
  FPedidoDAO.Free;
  inherited;
end;

// ---------------------- BUSCAS ----------------------------

function TPedidoController.BuscarCliente(Codigo: Integer): TClienteModel;
begin
  Result := FClienteDAO.Buscar(Codigo);
end;

function TPedidoController.BuscarProduto(Codigo: Integer): TProdutoModel;
begin
  Result := FProdutoDAO.Buscar(Codigo);
end;

// ------------------------ NOVO ----------------------------

function TPedidoController.NovoPedido: TPedidoModel;
begin
  FreeAndNil(FPedido);
  FPedido := TPedidoModel.Create;
  Result := FPedido;
end;

// ----------------------- ITENS ----------------------------

procedure TPedidoController.AdicionarItem(CodProd: Integer; Qtd: Double; ValorUnit: Double);
var
  Item: TPedidoItemModel;
begin
  Item := TPedidoItemModel.Create;
  Item.CodigoProduto := CodProd;
  Item.Quantidade := Qtd;
  Item.VrUnitario := ValorUnit;
  Item.VrTotal := Qtd * ValorUnit;

  FPedido.Itens.Add(Item);
  AtualizarTotal;
end;

procedure TPedidoController.EditarItem(Index: Integer; Qtd: Double; ValorUnit: Double);
var
  Item: TPedidoItemModel;
begin
  if (Index < 0) or (Index >= FPedido.Itens.Count) then
    Exit;

  Item := FPedido.Itens[Index];

  Item.Quantidade := Qtd;
  Item.VrUnitario := ValorUnit;
  Item.VrTotal := Qtd * ValorUnit;

  AtualizarTotal;
end;

procedure TPedidoController.RemoverItem(Index: Integer);
begin
  if (Index < 0) or (Index >= FPedido.Itens.Count) then
    Exit;

  FPedido.Itens.Delete(Index);
  AtualizarTotal;
end;

// ---------------------- TOTAL ------------------------------

procedure TPedidoController.AtualizarTotal;
var
  Total: Double;
  Item: TPedidoItemModel;
begin
  Total := 0;
  for Item in FPedido.Itens do
    Total := Total + Item.VrTotal;

  FPedido.ValorTotal := Total;
end;

// ---------------------- BD ------------------------------

function TPedidoController.GravarPedido: Integer;
begin
  Result := FPedidoDAO.GravarPedido(TPedidoModel);
end;

function TPedidoController.CarregarPedido(Numero: Integer): TPedidoModel;
begin
  Result := FPedidoDAO.CarregarPedido(Numero);
  FPedido.Free;
  FPedido := Result;
end;

procedure TPedidoController.CancelarPedido(Numero: Integer);
begin
  FPedidoDAO.CancelarPedido(Numero);
end;

end.

