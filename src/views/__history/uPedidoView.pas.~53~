unit uPedidoView;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.Grids,
  Vcl.Buttons, uPedidoController, uPedidoItemModel, uPedidoModel,
  uClienteModel, uProdutoModel, FireDAC.UI.Intf, FireDAC.VCLUI.Wait,
  FireDAC.Stan.Intf, FireDAC.Comp.UI, FireDAC.Phys.MySQLDef, FireDAC.Phys,
  FireDAC.Phys.MySQL;

type
  TfrmPedidoView = class(TForm)
    edtCodCliente: TEdit;
    edtNomeCliente: TEdit;
    btnBuscarCliente: TBitBtn;

    edtCodProduto: TEdit;
    edtQtd: TEdit;
    edtVrUnit: TEdit;
    btnInserirItem: TBitBtn;

    sgItens: TStringGrid;

    edtTotal: TEdit;
    Label5: TLabel;

    btnGravar: TBitBtn;
    btnCarregar: TBitBtn;
    btnCancelar: TBitBtn;
    FDGUIxWaitCursor1: TFDGUIxWaitCursor;
    FDPhysMySQLDriverLink1: TFDPhysMySQLDriverLink;

    procedure FormCreate(Sender: TObject);
    procedure btnBuscarClienteClick(Sender: TObject);
    procedure btnInserirItemClick(Sender: TObject);
    procedure sgItensKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure btnGravarClick(Sender: TObject);
    procedure btnCarregarClick(Sender: TObject);
    procedure btnCancelarClick(Sender: TObject);

  private
    FController: TPedidoController;
    procedure AtualizarGrid;
    procedure LimparCamposProduto;
    procedure LimparPedido;
    procedure AtualizarBotoes;
  public
  end;

var
  frmPedidoView: TfrmPedidoView;

implementation

{$R *.dfm}

procedure TfrmPedidoView.FormCreate(Sender: TObject);
begin
  AtualizarBotoes;
  FController := TPedidoController.Create;

  sgItens.ColCount := 5;
  sgItens.RowCount := 1;
  sgItens.Options := sgItens.Options + [goRowSelect];
  sgItens.Options := sgItens.Options - [goEditing];

  sgItens.Cells[0,0] := 'Código';
  sgItens.Cells[1,0] := 'Descrição';
  sgItens.Cells[2,0] := 'Qtd';
  sgItens.Cells[3,0] := 'Vlr Unit';
  sgItens.Cells[4,0] := 'Vlr Total';
  sgItens.TabStop := True;
end;

{ -------------------------------------------------------------
  BUSCAR CLIENTE
-------------------------------------------------------------- }

procedure TfrmPedidoView.btnBuscarClienteClick(Sender: TObject);
var
  C: TClienteModel;
begin
  C := FController.BuscarCliente(StrToIntDef(edtCodCliente.Text, 0));

  if C = nil then
  begin
    ShowMessage('Cliente não encontrado!');
    edtNomeCliente.Clear;
    Exit;
  end;

  edtNomeCliente.Text := C.Nome;

  FController.Pedido.CodCliente := C.Codigo;
  AtualizarBotoes;
end;

{ -------------------------------------------------------------
  INSERIR ITEM
-------------------------------------------------------------- }

procedure TfrmPedidoView.btnInserirItemClick(Sender: TObject);
var
  Prod: TProdutoModel;
  CodProd: Integer;
  Qtd, VlrUnit: Double;
begin
  CodProd := StrToIntDef(edtCodProduto.Text, 0);
  Qtd     := StrToFloatDef(edtQtd.Text, 0);
  VlrUnit := StrToFloatDef(edtVrUnit.Text, 0);

  Prod := FController.BuscarProduto(CodProd);

  if Prod = nil then
  begin
    ShowMessage('Produto não encontrado!');
    Exit;
  end;

  if (Qtd <= 0) or (VlrUnit <= 0) then
  begin
    ShowMessage('Informe quantidade e valor unitário');
    Exit;
  end;


  FController.AdicionarItem(CodProd, Qtd, VlrUnit);

  AtualizarGrid;
  edtTotal.Text := CurrToStrF(
    Currency(FController.Pedido.ValorTotal),
    ffCurrency,
    2
  );

  LimparCamposProduto;
  sgItens.SetFocus;
end;

{ -------------------------------------------------------------
  ATUALIZAR GRID
-------------------------------------------------------------- }

procedure TfrmPedidoView.AtualizarGrid;
var
  I: Integer;
  Item: TPedidoItemModel;
  Prod: TProdutoModel;
begin
  sgItens.RowCount := FController.Pedido.Itens.Count + 1;

  for I := 0 to FController.Pedido.Itens.Count - 1 do
  begin
    Item := FController.Pedido.Itens[I];
    Prod := FController.BuscarProduto(Item.CodigoProduto);

    sgItens.Cells[0, I+1] := Item.CodigoProduto.ToString;
    if Prod <> nil then
      sgItens.Cells[1, I+1] := Prod.Descricao
    else
      sgItens.Cells[1, I+1] := '';
    sgItens.Cells[2, I+1] := FloatToStr(Item.Quantidade);
    sgItens.Cells[3, I+1] := FloatToStr(Item.VrUnitario);
    sgItens.Cells[4, I+1] := FloatToStr(Item.VrTotal);
  end;
end;

procedure TfrmPedidoView.LimparCamposProduto;
begin
  edtCodProduto.Clear;
  edtQtd.Clear;
  edtVrUnit.Clear;
  edtCodProduto.SetFocus;
end;

{ -------------------------------------------------------------
  EDIÇÃO E REMOÇÃO PELO GRID
-------------------------------------------------------------- }

procedure TfrmPedidoView.sgItensKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
var
  Index: Integer;
begin
  Index := sgItens.Row - 1;

  // DELETE → Remover item
  if Key = VK_DELETE then
  begin
    if (Index >= 0) and
      (MessageDlg('Remover item?', mtConfirmation, [mbYes, mbNo], 0) = mrYes)
    then
    begin
      FController.RemoverItem(Index);
      AtualizarGrid;
      edtTotal.Text := FloatToStr(FController.Pedido.ValorTotal);
    end;
  end;

  // ENTER → Editar item
  if Key = VK_RETURN then
  begin
    if Index >= 0 then
    begin
      edtCodProduto.Text := sgItens.Cells[0, sgItens.Row];
      edtQtd.Text        := sgItens.Cells[2, sgItens.Row];
      edtVrUnit.Text     := sgItens.Cells[3, sgItens.Row];

      FController.RemoverItem(Index);
      AtualizarGrid;

      edtCodProduto.SetFocus;
    end;
  end;
end;

{ -------------------------------------------------------------
  GRAVAR PEDIDO
-------------------------------------------------------------- }

procedure TfrmPedidoView.btnGravarClick(Sender: TObject);
begin
  // Valida cliente NO MODEL
  if FController.Pedido.CodCliente = 0 then
  begin
    ShowMessage('Informe o cliente antes de gravar o pedido.');
    edtCodCliente.SetFocus;
    Exit;
  end;

  // Valida itens
  if FController.Pedido.Itens.Count = 0 then
  begin
    ShowMessage('Informe ao menos um produto no pedido.');
    edtCodProduto.SetFocus;
    Exit;
  end;

  FController.GravarPedido;

  edtTotal.Text := CurrToStrF(
    Currency(FController.Pedido.ValorTotal),
    ffCurrency,
    2
  );

  ShowMessage(
    'Pedido gravado com sucesso! Número: ' +
    FController.Pedido.Numero.ToString
  );

  LimparPedido;
end;

{ -------------------------------------------------------------
  CARREGAR PEDIDO
-------------------------------------------------------------- }

procedure TfrmPedidoView.btnCarregarClick(Sender: TObject);
var
  Num: Integer;
  P: TPedidoModel;
begin
  Num := StrToInt(InputBox('Carregar Pedido', 'Número do pedido:', ''));

  P := FController.CarregarPedido(Num);

  if P = nil then
  begin
    ShowMessage('Pedido não encontrado!');
    Exit;
  end;

  edtCodCliente.Text := P.CodCliente.ToString;
  btnBuscarClienteClick(nil);

  AtualizarGrid;
  edtTotal.Text := FloatToStr(P.ValorTotal);
  AtualizarBotoes;
end;

{ -------------------------------------------------------------
  CANCELAR PEDIDO
-------------------------------------------------------------- }

procedure TfrmPedidoView.btnCancelarClick(Sender: TObject);
var
  Num: Integer;
begin
  Num := StrToInt(InputBox('Cancelar Pedido', 'Número do pedido:', ''));

  FController.CancelarPedido(Num);

  ShowMessage('Pedido cancelado!');
end;

procedure TfrmPedidoView.LimparPedido;
begin
  // Cliente
  edtCodCliente.Clear;
  edtNomeCliente.Clear;

  // Itens
  sgItens.RowCount := 1;

  // Total
  edtTotal.Text := CurrToStrF(0, ffCurrency, 2);

  // Novo pedido em memória
  FController.NovoPedido;

  edtCodCliente.SetFocus;
end;

procedure TfrmPedidoView.AtualizarBotoes;
var
  ClienteEmBranco: Boolean;
begin
  ClienteEmBranco := Trim(edtCodCliente.Text) = '';

  btnCarregar.Visible := ClienteEmBranco;
  btnCancelar.Visible := ClienteEmBranco;
end;

end.

